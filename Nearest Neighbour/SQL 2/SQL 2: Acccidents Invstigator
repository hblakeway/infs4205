-- An investigator wants to analyse the latest accidents. Coming from the local police station the officer wants to find
-- the shortest and fastest route to get to all accidents in the city. It can be assumed that the officer gets to one accident per hour. 
-- We can limit the query to 8

-- Find which city had the most accidents on one day : Waukesha, 2021-11-22, 104
SELECT DISTINCT accident_locations.city, DATE(end_time), COUNT(*) AS occurences
FROM accident_locations 
GROUP BY accident_locations.city, end_time
ORDER BY occurences DESC;

-- Visual all relevant accidents 
SELECT * 
FROM accident_locations
WHERE city = 'Waukesha' AND DATE(end_time) = '2021-11-22';

-- Find shortest route to reach all points from police station where investigator is 
-- 43.029580131264126, -88.24194066974728
SELECT accidents.id, ST_Transform(accidents.geompoint, 4326),
  accidents.geompoint <-> 'SRID=4326;POINT(-88.24194066974728 43.029580131264126)'::geometry AS dist
FROM accident_locations accidents
WHERE accidents.city = 'Waukesha' AND DATE(end_time) = '2021-11-22'
ORDER BY dist ASC
LIMIT 8;

-- Harvensine Formula to transform from euclidian to great circle:
-- https://stackoverflow.com/questions/27708490/haversine-formula-definition-for-sql
-- ( 3959 * acos( cos( radians(Lat1) ) * cos( radians( Lat2 ) ) * cos( radians(Lng2) - radians(Lng1) ) + sin( radians(Lat1) ) * sin( radians(Lat2))))
CREATE TABLE investigator_locations AS
SELECT accidents.id, accidents.end_lat, accidents.end_lng, ( 3959 * acos( cos( radians(43.029580131264126) ) * cos( radians(accidents.end_lat) ) * cos( radians(accidents.end_lng) - radians(-88.24194066974728) ) + sin( radians(43.029580131264126) ) * sin( radians(accidents.end_lat)))) AS dist
FROM accident_locations accidents
WHERE accidents.city = 'Waukesha' AND DATE(end_time) = '2021-11-22'
ORDER BY dist ASC
LIMIT 8;

-- Used NN as TSP is not effective on large datasets. Did not create a route as it would be unrealistive. Need edges of streets.
-- Reword query as 
-- Find 8 nearest accidents for investigator in investigate. 







